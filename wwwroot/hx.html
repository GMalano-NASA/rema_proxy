<script src="js/jquery.svg.js"></script>
<script src="js/jquery.svgdom.js"></script>
<script src="js/jquery.svganim.js"></script>

<link rel="stylesheet" type="text/css" href="css/datatables.min.css" />

<script type="text/javascript" src="js/datatables.min.js"></script>

<style>
svg .tube.clicked {
	fill: #29ABE2;
}

svg .tube:hover {
	stroke: lime;
}
</style>

<div id="hx_tab"
	style="overflow: visible; height: 88%; width: 100%; float: left; position: relative;">

	<div id="tube_info"
		style="position: relative; width: 100%; float: left; vertical-align: middle; height: 4%">
		<div
			style="position: relative; width: 50%; height: 100%; float: left;">
			Tube Info X:<input type="text" id="tube_info_x" size="4"> Y:<input
				type="text" id="tube_info_y" size="4"> <input type="button"
				name="start" value="GO">
		</div>
	</div>

	<div style="padding-bottom: 30px; height: 98%" class="container_div">
		<div
			style="position: relative; overflow: scroll; text-align: center; height: 100%; width: 80%; align-content: center; float: left; resize: horizontal; min-width: 20%; max-width: 80%"
			id="hx_svg_div" class="left-side">
			<svg id="hx_svg" style="position: relative; cursor: crosshair;"
				onmousemove="displayCoordinates(event)"></svg>
		</div>

		<div id="tubesheet_tab" class="right-side"
			style="overflow: scroll; width: 20%; height: 100%; float: left; position: relative;">
			<table id="my-table" class="datatables display" style="width: 100%">
				<thead>
					<tr>
						<th>CL_X</th>
						<th>CL_Y</th>
						<th>HL_X</th>
						<th>HL_Y</th>
						<th>X_LABEL</th>
						<th>Y_LABEL</th>
						<th>TUBE_ID</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
	</div>

	<div style="padding: 10px; width: 100%">
		<div id="coordinates" style="float: left; width: 40%">Coordinates:</div>
		<div
			style="position: relative; width: 50%; float: left; vertical-align: middle;">
			<div
				style="float: left; padding-right: 10px; width: 10%; text-align: right;">Zoom:</div>
			<div id="zoom-bar" style="float: left; width: 70%;"></div>
		</div>
	</div>
</div>

<script type="text/javascript">
	function displayCoordinates(event) {
		var svg = document.getElementById("tubesheet_svg");
		var point = svg.createSVGPoint();
		point.x = event.clientX;
		point.y = event.clientY;
		var svgCoords = point.matrixTransform(svg.getScreenCTM().inverse());
		var x = svgCoords.x;
		var y = svgCoords.y;
		document.getElementById("coordinates").innerHTML = "Coordinates: " + x
				+ ", " + y;
	}

	function drawIntro(svg) {
		var g = svg.group({
			stroke : 'green',
			strokeWidth : 0.02,
			id : "bulls_eye"
		});

		svg.circle(g, 0, 0, 0.4, {
			fill : 'none',
			stroke : 'red',
			strokeWidth : 0.03
		});

		svg.line(g, -20, 0, 20, 0, {
			"stroke-dasharray" : "0.2, 0.1"
		});

		svg.line(g, 0, -20, 0, 20, {
			"stroke-dasharray" : "0.2, 0.1"
		});

		var pin = svg.group({
			stroke : 'red',
			strokeWidth : 0.02,
			id : "location_pin",
			transform : "rotate(45, 0, 0)"
		});

		svg.rect(pin, -0.3, -0.3, 0.3, 0.3, {
			fill : 'red',
			stroke : 'red',
			strokeWidth : 0.02
		});

		svg.circle(pin, -0.3, -0.3, 0.3, {
			fill : 'red',
			stroke : 'red',
			strokeWidth : 0.02
		});

		svg.circle(pin, -0.3, -0.3, 0.15, {
			fill : 'white',
			stroke : 'red',
			strokeWidth : 0.02
		});
	}

	function update_bulls_eye_position(x, y) {
		$("#bulls_eye").animate({
			svgTransform : 'translate(' + x + " " + y + ')'
		}, 20);
	}

	function update_location_pin_position(x, y) {
		$("#location_pin").animate({
			svgTransform : 'translate(' + x + " " + y + ') rotate(45 0 0)'
		}, 500);
	}

	$(function() {

		var table = $('#my-table').DataTable({
			"ajax" : {
				method : "post",
				url : "/json/hx_load_tubesheet",
				dataSrc : '',
			},
			columns : [ {
				data : 'cl_x'
			}, {
				data : 'cl_y'
			}, {
				data : 'hl_x'
			}, {
				data : 'hl_y'
			}, {
				data : 'x_label'
			}, {
				data : 'y_label'
			}, {
				data : 'tube_id'
			}, ],
		});

		$('#my-table tbody').on('click', 'tr', function() {
			var data = table.row(this).data();
			update_location_pin_position(data.hl_x, data.hl_y);
		});

		$("#tubesheet_svg").svg({
			onLoad : drawIntro
		});

		var aspectRatio = 1.5;

		function zoom_svg(zoom, ar) {
			$('#hx_svg').css("width", 100 * zoom / 3 + "%");
			$('#hx_svg').css("height", 100 * zoom / ar + "%");
		}

		$('#hx_svg')
				.load(
						'tubesheet.svg',
						function() {
							var tubesheet_svg = document
									.getElementById('tubesheet_svg');
							var box = tubesheet_svg.viewBox.baseVal;

							aspectRatio = box.width / box.height;

							var tubes = $(
									'#tubesheet_svg .tube_num, #tubesheet_svg circle ')
									.click(
											function() {
												var clickmark = 'clicked';
												var t = $(this).parent();
												if (t.find("circle").hasClass(
														clickmark)) {
													t.children("circle")
															.removeClass(
																	clickmark);
													table.columns(6).search("")
															.draw();
													update_location_pin_position(
															0, 0);
												} else {
													tubes.not(t).removeClass(
															clickmark);
													t.find("circle").addClass(
															clickmark);
													var cx = $(t)
															.find("circle")
															.first().attr("cx")
													var cy = $(t)
															.find("circle")
															.first().attr("cy")
													$("#tube_info_x").val(cx);
													$("#tube_info_y").val(cy);
													update_location_pin_position(
															cx, cy);

													var val = $(t).find("text")
															.first().text()
													table.columns(6).search(
															val ? '^' + val
																	+ '$' : '',
															true, false).draw();

												}

											});

							var zoom_bar = $("#zoom-bar").slider({
								min : 3,
								max : 10,
								change : function(event, ui) {
									zoom_svg(ui.value, aspectRatio);
								}
							});

							zoom_svg(zoom_bar.slider("value"), aspectRatio);

							$("#tubesheet_svg").svg({
								onLoad : drawIntro
							});

						});

		function resize_divs() {
			var left_div = $(".left-side");
			var left_width = left_div.width() / left_div.parent().width() * 100;
			
			$(".right-side").width(99 - left_width + "%");
			console.log($(".right-side").width());
		}

		new ResizeObserver(resize_divs).observe(hx_svg_div)
		
	});
</script>