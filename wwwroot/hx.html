<script src="js/jquery.svg.js"></script>
<script src="js/jquery.svgdom.js"></script>
<script src="js/jquery.svganim.js"></script>

<link rel="stylesheet" type="text/css" href="css/datatables.min.css" />
<link rel="stylesheet" type="text/css"
	href="css/select.dataTables.min.css" />
<link rel="stylesheet" type="text/css"
	href="css/scroller.dataTables.min.css" />


<script type="text/javascript" src="js/datatables.min.js"></script>
<script type="text/javascript" src="js/dataTables.select.min.js"></script>
<script type="text/javascript" src="js/dataTables.scroller.min.js"></script>

<style>
svg .tube.clicked {
	fill: #29ABE2;
}

svg .tube:hover {
	stroke: lime;
}

</style>

<div id="hx_tab"
	style="overflow: visible; height: 88%; width: 100%; float: left; position: relative;">

	<div id="tube_info"
		style="position: relative; width: 100%; float: left; vertical-align: middle; height: 4%" >
		<div
			style="position: relative; width: 80%; height: 100%; float: left;" class="left-side">
			Tube Info X:<input type="text" id="tube_info_x" size="4"> Y:<input
				type="text" id="tube_info_y" size="4"> <input type="button"
				name="start" value="GO">
		</div>
		<div style="float: right; text-align: center; " class="right-side">
			<select id="insp_plans"></select>
		</div>
	</div>

	<div style="padding-bottom: 30px; height: 95%">
		<div
			style="position: relative; overflow: scroll; text-align: center; height: 100%; width: 80%; align-content: center; float: left; resize: horizontal; min-width: 20%; max-width: 80%"
			id="left_side_resizable">
			<svg id="hx_svg" style="position: relative; cursor: crosshair;"
				onmousemove="displayCoordinates(event)"></svg>
		</div>

		<div id="tubesheet_tab" class="right-side"
			style="overflow: scroll; width: 20%; height: 100%; float: left; position: relative;">
			<table id="insp_plan_table" class="datatables display"
				style="width: 100%">
				<thead>
					<tr>
						<th>TUBE_ID</th>
						<th>COL</th>
						<th>ROW</th>
						<th>INSPECTED</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
	</div>

	<div style="padding: 10px; width: 100%">
		<div id="coordinates" style="float: left; width: 40%">Coordinates:</div>
		<div
			style="position: relative; width: 50%; float: left; vertical-align: middle;">
			<div
				style="float: left; padding-right: 10px; width: 10%; text-align: right;">Zoom:</div>
			<div id="zoom_bar" style="float: left; width: 70%;"></div>
		</div>
	</div>
</div>

<script type="text/javascript">
	function displayCoordinates(event) {
		var svg = document.getElementById("tubesheet_svg");
		var point = svg.createSVGPoint();
		point.x = event.clientX;
		point.y = event.clientY;
		var svgCoords = point.matrixTransform(svg.getScreenCTM().inverse());
		var x = svgCoords.x;
		var y = svgCoords.y;
		document.getElementById("coordinates").innerHTML = "Coordinates: " + x
				+ ", " + y;
	}

	function drawIntro(svg) {
		var g = svg.group({
			stroke : 'green',
			strokeWidth : 0.02,
			id : "bulls_eye"
		});

		svg.circle(g, 0, 0, 0.4, {
			fill : 'none',
			stroke : 'red',
			strokeWidth : 0.03
		});

		svg.line(g, -20, 0, 20, 0, {
			"stroke-dasharray" : "0.2, 0.1"
		});

		svg.line(g, 0, -20, 0, 20, {
			"stroke-dasharray" : "0.2, 0.1"
		});

		var pin = svg.group({
			stroke : 'red',
			strokeWidth : 0.02,
			id : "location_pin",
			transform : "rotate(45, 0, 0)"
		});

		svg.rect(pin, -0.3, -0.3, 0.3, 0.3, {
			fill : 'red',
			stroke : 'red',
			strokeWidth : 0.02
		});

		svg.circle(pin, -0.3, -0.3, 0.3, {
			fill : 'red',
			stroke : 'red',
			strokeWidth : 0.02
		});

		svg.circle(pin, -0.3, -0.3, 0.15, {
			fill : 'white',
			stroke : 'red',
			strokeWidth : 0.02
		});
	}

	function update_bulls_eye_position(x, y) {
		$("#bulls_eye").animate({
			svgTransform : 'translate(' + x + " " + y + ')'
		}, 20);
	}

	function update_location_pin_position(x, y) {
		$("#location_pin").animate({
			svgTransform : 'translate(' + x + " " + y + ') rotate(45 0 0)'
		}, 500);
	}

	$(function() {

		var insp_plans_dropdown = $('#insp_plans');

		var table = $('#insp_plan_table')
				.DataTable(
						{
							select : true,
							scroller: true,
							scrollX: true,
							sScrollY: '500px',
							ajax : {
								method : "post",
								dataType : 'json',
								url : "/json/insp_plan_load",
								data : function() {
									return JSON.stringify({
										'insp_plan_path' : $("#insp_plans")
												.val()
									});
								},
								dataSrc : '',
							},
							columns : [
									{
										data : 'tube_id'
									},
									{
										data : 'col'
									},
									{
										data : 'row'
									},
									{
										data : 'inspected',
										render : function(data, type, row) {
											$("#" + row.tube_id,
													$("#tubesheet_svg"))
													.children("circle")
													.css(
															"fill",
															insp_plans_dropdown
																	.css("background-color"));

											return '<input type="checkbox" value='
													+ row.tube_id
													+ (data == 'true' ? ' checked'
															: '') + '>';
										}
									}, ],
						});

		function get_session_info() {
			return $.post('/json/session_info');
		}

		get_session_info()
				.done(
						function(data) {
							tubesheet_path = svg_load("../"
									+ (data.tubesheet_svg_path || "/static/no_session_loaded.svg"));

							insp_plans_dropdown.empty();
							insp_plans_dropdown
									.append('<option selected="true">Choose an Inspection Plan</option>');
							insp_plans_dropdown.prop('selectedIndex', 0);

							// Populate dropdown with list of Inspection Plans 		
							var pastel_colors = [ "#ffadad", "#ffd6a5",
									"#fdffb6", "#caffbf", "#9bf6ff", "#a0c4ff",
									"#bdb2ff", "#ffc6ff", "#ffffbb" ];
							var color = 0;
							$
									.each(
											data.inspection_plans,
											function(key, entry) {
												insp_plans_dropdown
														.append($(
																'<option style="background-color:' + pastel_colors[color] + '; "></option>')
																.attr(
																		'value',
																		entry.value)
																.text(
																		entry.text));
												color++;
												color %= pastel_colors.length;
											});

							insp_plans_dropdown.change(function() {
								insp_plans_dropdown.css("background-color", $(
										"option:selected", this).css(
										"background-color"));
								table.ajax.reload();
							});
						});

		$('#insp_plan_table tbody').on(
				'click',
				'tr',
				function() {
					var data = table.row(this).data();
					var cx = $("#" + data.tube_id, $("#tubesheet_svg"))
							.children("circle").first().attr("cx");
					var cy = $("#" + data.tube_id, $("#tubesheet_svg"))
							.children("circle").first().attr("cy");

					update_location_pin_position(cx, cy);
				});

		$("#tubesheet_svg").svg({
			onLoad : drawIntro
		});

		var aspectRatio = 1.5;

		function zoom_svg(zoom, ar) {
			$('#hx_svg').css("width", 100 * zoom / 3 + "%");
			$('#hx_svg').css("height", 100 * zoom / ar + "%");
		}

		function svg_load(path) {
			$('#hx_svg')
					.load(
							path,
							function() {
								var tubesheet_svg = document
										.getElementById('tubesheet_svg');
								var box = tubesheet_svg.viewBox.baseVal;

								aspectRatio = box.width / box.height;

								var tubes = $(
										'#tubesheet_svg .tube_num, #tubesheet_svg circle ')
										.click(
												function() {
													var tube_id_column = 0
													var clickmark = 'clicked';
													var t = $(this).parent();
													if (t
															.find("circle")
															.hasClass(clickmark)) {
														t
																.children(
																		"circle")
																.removeClass(
																		clickmark);
														table.rows().deselect();

														update_location_pin_position(
																0, 0);
													} else {
														tubes
																.not(t)
																.removeClass(
																		clickmark);
														t
																.find("circle")
																.addClass(
																		clickmark);
														var cx = $(t).find(
																"circle")
																.first().attr(
																		"cx");
														var cy = $(t).find(
																"circle")
																.first().attr(
																		"cy");
														$("#tube_info_x").val(
																cx);
														$("#tube_info_y").val(
																cy);
														update_location_pin_position(
																cx, cy);

														var val = $(t).find(
																"text").first()
																.text();
																
														table.rows().deselect();
														table.rows().every( function ( rowIdx, tableLoop, rowLoop ) {
														
															var data = this.data();							
														    if (data["tube_id"] == val) {														    	
														    	this.select().scrollTo();
														    } 
														} );
													}

												});

								var zoom_bar = $("#zoom_bar").slider({
									min : 3,
									max : 10,
									change : function(event, ui) {
										zoom_svg(ui.value, aspectRatio);
									}
								});

								zoom_svg(zoom_bar.slider("value"), aspectRatio);

								$("#tubesheet_svg").svg({
									onLoad : drawIntro
								});
							});
		}

		function resize_divs() {
			var left_div = $("#left_side_resizable");
			var left_width = left_div.width() / left_div.parent().width() * 100;
			
			$(".left-side").width(left_width + "%");
			$(".right-side").width(98 - left_width + "%");
		}

		new ResizeObserver(resize_divs).observe(document.getElementById("left_side_resizable"));

	});
</script>