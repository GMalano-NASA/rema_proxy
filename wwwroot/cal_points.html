<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type="text/css" href="css/datatables.min.css" />
<link rel="stylesheet" type="text/css"
	href="css/select.dataTables.min.css" />
<link rel="stylesheet" type="text/css"
	href="css/scroller.dataTables.min.css" />

<style type="text/css">
.container {
    display: flex;
    justify-content: space-between;
    align-items: stretch;
}


svg .tube.highlight_cal_tube  {
	fill: lightgreen;
}

.column {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    align-items: flex-start;
    flex-grow: 2;
    justify-content: center; /* align item horizontally */
    align-items: center; /* align item vertically */
    flex-basis: auto;
}

.row {
	justify-content: center; /* align item horizontally */
    align-items: center; /* align item vertically */
	display: flex;
	flex-direction: row;
	flex-grow: 1;
	position: relative;
	width:100%;
}

.content {
	justify-content: center; /* align item horizontally */
    align-items: center; /* align item vertically */
	display: flex;
	flex-grow: 1;	
	vertical-align: middle;	
	align-items: center; 
	align-content: center;
}
</style>


</head>
<body>
<div id="calibration_div">
	<div style="display: flex; flex-direction: column; height: 100%; align-content: center;">
		<div style="display: flex; flex-grow: 2;">
			<table id="calibration_table" class="datatables display my-table"
				style="width: 100%">
				<thead>
					<tr>
						<th>ID</th>
						<th>Col</th>
						<th>Row</th>
						<th>Calibrated</th>
						<th>Options</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
		<div class="row" style="width: 100%">
			<hr>
		</div>
		<div>
			<form id="cal_point_info">			
				<div class="row">
				Tube Id:<input type="text" size="4" id="cal_point_tube_id" name="tube_id"> 
					Col:<input type="text" size="4" id="cal_tube_info_col" name="col"> 
					Row:<input type="text" size="4" id="cal_tube_info_row" name="row"> 
				</div>
				<div style="padding: 10px;" class="row">
					<button id="set_as_cal_point" disabled="disabled">Set as Calibration Point</button>
				</div>
				<div class="container">
			        <div class="column" style="width: 70%">
			        	<div class="row">
			        		<div class="content"></div>
			        		<div class="content">Ideal</div>
			        		<div class="content">Determined</div>
			        	</div>			            
			            <div class="row">
			            	<div class="content">X:</div>
				            <div class="content"><input type="text" size="6" id="ideal_coords_x" name="ideal_coords_x"></div>
				            <div class="content"><input type="text" size="6" id="determined_coords_x" name="determined_coords_x"></div>
			            </div>			            
			           	<div class="row">
			            	<div class="content">Y:</div>
				            <div class="content"><input type="text" size="6" id="ideal_coords_y" name="ideal_coords_y"></div>
				            <div class="content"><input type="text" size="6" id="determined_coords_y" name="determined_coords_y"></div>
			            </div>			            
			            <div class="row">
			            	<div class="content">Z:</div>
				            <div class="content"><input type="text" size="6" id="ideal_coords_z" name="ideal_coords_z"></div>
				            <div class="content"><input type="text" size="6" id="determined_coords_z" name="determined_coords_z"></div>
			            </div>
			        </div>
			        <div class="column" style="vertical-align: middle; align-items: center; width: 30%">
			        	<button style="position: relative; width:80%" id="copy_center">Copy</button>
			            <button style="position: relative; width:80%" id="determine_center">Center</button>
			            <button style="position: relative; width:80%" id="cal_point_update">Update</button>
			        </div>
			    </div>
			</form>				
		</div>
		<div class="row">
			<button id="show_hide_aligned_tubesheet">Show Aligned Tubesheet</button>
		</div>		
	</div>
</div>

<script type="text/javascript">

//Shows information of the selected tube either on the datatables or the HX itself
function show_cal_point_info(data, from_table = false) {
	var table = $('#calibration_table').DataTable();
	if (!from_table) {
		table.rows().deselect();
	}	
	
	if(data===null) {
		$("#cal_point_info input[type=text]").val("");	
	} else {
		$("#cal_point_tube_id").val(data.tube_id);
		$("#cal_tube_info_col").val(data.col);
		$("#cal_tube_info_row").val(data.row);
		$("#ideal_coords_x").val(data.ideal_coords.x);
		$("#ideal_coords_y").val(data.ideal_coords.y);
		$("#ideal_coords_z").val(data.ideal_coords.z);
		$("#determined_coords_x").val(data.determined_coords.x);
		$("#determined_coords_y").val(data.determined_coords.y);
		$("#determined_coords_z").val(data.determined_coords.z);
	}
}

function highlight_calibration_tube(g) {
	var table = $('#calibration_table').DataTable();
	var tubes = $(
			'#tubesheet_svg .tube_num, #tubesheet_svg circle ');
	var highlight = 'highlight_cal_tube';

	if (g
			.find("circle")
			.hasClass(highlight)) {
		g
				.children(
						"circle")
				.removeClass(
						highlight);
		table.rows().deselect();
	} else {
		tubes
				.not(g)
				.removeClass(
						highlight);
		g
				.find("circle")
				.addClass(
						highlight);
	}
}

function remove_highlight_calibration_tube(g) {
	var tubes = $(
			'#tubesheet_svg .tube_num, #tubesheet_svg circle ');
	var highlight = 'highlight_cal_tube';
	tubes.removeClass(highlight);
}

function drawAlignedCircle(svg, id, coords, radius, scale) {		
	stroke = 0.03 * scale;
	
	var g = svg.group({
		stroke : 'blue',
		strokeWidth : stroke,
		"class" : "determined_tube",
		transform : "scale(1,-1)",
		id : "determined_" + id, 
	});

	svg.circle(g, coords.x, coords.y, radius * scale, {
		fill : 'none',
		stroke : 'blue',
		strokeWidth : stroke,					
	});
}


$(function() {
	var table = $('#calibration_table')
	.DataTable(
			{
				deferRender: true,
				select : true,
				scrollX : true,						
				ajax : {
					method : "GET",
					dataType : 'json',
					url : "/REST/calibration-points",
					data : function() {},
					dataSrc :function ( data ) {
						var array_data = [];
						$.each(data, function(id, tube) {
							tube.tube_id = id;
							array_data.push(tube);
						});
						return array_data;
					} 						
				},
				columns : [
						{
							data : 'tube_id'
						},
						{
							data : 'col'
						},
						{
							data : 'row'
						},
						{
							data : 'determined',
							render : function(data, type, row) {
								return '<input type="checkbox" value='
										+ row.tube_id
										+ (data == true ? ' checked'
												: '') + '>';
							}
						},
						{
							data : null,
							render : function(data, type, row) {
								return '<a class="ui-icon ui-icon-trash" href="#" data-tube_id="'
										+ row.tube_id + '">' + row.tube_id
										+ '</a>';
							}
						}, 
				],
				
			});
	
	table.on('draw.dt', function(e, settings, json, xhr) {			
		$(".ui-icon-trash").on("click", function() {			
			var tube_id = $(this).data("tube_id").toString();
			
			var confirm_action = confirm("Are you sure you want to delete " + tube_id + " ?");
	        if (confirm_action) {
	        	$.ajax({
					url : "/REST/calibration-points/" + tube_id,
					type : "DELETE",
					success: function(data) {
						table.ajax.reload();
					},
					error: function(xhr, status, error) {
						alert("Error");
						console.log("Error", status, error);
					}						
	        	});
	        }
		});
	});
	
	
	table.on('click', 'tr',
		function() {				
			currentRow = table.row(this);					// Store the selected row on click
			if (!currentRow.selected()) {
				var data = currentRow.data();				
				show_cal_point_info(data, true);
				var g = $("#"+ data.tube_id, $("#tubesheet_svg"));
				highlight_calibration_tube(g);
			} else {				
				$("#cal_point_info input[type=text]").val("");
				remove_highlight_calibration_tube();
			}
			
		}
	);
	
	$("#set_as_cal_point").click(function(e) {
		e.preventDefault();
		$.ajax({
			method : "POST",
			url : "/REST/calibration-points",
			data: JSON.stringify(Object.fromEntries(new FormData(document.getElementById("cal_point_info")))),
			success : function() {
				table = $('#calibration_table').DataTable();
				table.ajax.reload();
			},
			error: function(xhr, status, error) {
				alert("Error");
				console.log("Error", status, error);
			}						
		});
	});

	$("#copy_center").click(function(e) {
		e.preventDefault();
		$("#determined_coords_x").val($("#ideal_coords_x").val());
		$("#determined_coords_y").val($("#ideal_coords_y").val());
		$("#determined_coords_z").val($("#ideal_coords_z").val());
	}); 

	$("#determine_center").click(function(e) {
		e.preventDefault();
		cal_point_id = $("#cal_point_tube_id").val();
		
		if (cal_point_id === "") {
			alert("Select a tube from calibration points table");
			return;
		}
		
		Promise.resolve(
			$.ajax({
				method : "GET",
				url : "/REST/determine-tube-center/" + cal_point_id,
				data : JSON.stringify(),
				timeout: 25000,
			}))
			.then(function(data) {
				var svg = $("#tubesheet_svg").svg("get");		
				console.log("Scale:", scale);
				data.center.x *= scale;
				data.center.y *= scale;
				data.center.z *= scale;
				drawCircle(svg, data.center, data.radius, scale);
				
				$("#determined_coords_x").val(data.center.x);
				$("#determined_coords_y").val(data.center.y);
				$("#determined_coords_z").val(data.center.z);			
			})
			.catch(function(e) {
				if(e.statusText == 'timeout') {     
				    // TODO Send a cancel command? 
					alert('Please have the touch prove inserted into the tube to be detected');
			    
				  }
			});			
	});	

	$("#cal_point_update").click(function(e) {
		e.preventDefault();
		cal_point_id = $("#cal_point_tube_id").val();
		$.ajax({
			method : "PUT",
			url : "/REST/calibration-points/" + cal_point_id,
			data: JSON.stringify(Object.fromEntries(new FormData(document.getElementById("cal_point_info")))),
			success : function() {
				$("#cal_point_info input[type=text]").val("");
				table = $('#calibration_table').DataTable();
				table.ajax.reload();
			},
			error: function(xhr, status, error) {
				alert("Error");
				console.log("Error", status, error);
			}						
		});
	});

	var showing_aligned_tubeseet = false;
	
	$("#show_hide_aligned_tubesheet").click(function(e) {
		if (showing_aligned_tubeseet) {
			$(".determined_tube").hide();
			showing_aligned_tubeseet = false;
			$("#show_hide_aligned_tubesheet").text("Show Aligned Tubesheet");
			
		} else {
			$.ajax({
				method : "GET",
				url : "/REST/aligned-tubesheet-get",
				success : function(data) {
					var svg = $("#tubesheet_svg").svg("get");					
					$.each(data, function(id, coords) {
						  //console.log(`${key}: ${value}`);
						  drawAlignedCircle(svg, id, coords, 0.05, scale);
					});
				},
				error: function(xhr, status, error) {
					alert("Error");
					console.log("Error", status, error);
				}						
			});
			showing_aligned_tubeseet = true;
			$("#show_hide_aligned_tubesheet").text("Hide Aligned Tubesheet");
		}
	});
	
	
	
});

</script>

</body>
</html>

