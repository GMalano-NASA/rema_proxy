<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type="text/css" href="css/datatables.min.css" />
<link rel="stylesheet" type="text/css"
	href="css/select.dataTables.min.css" />
<link rel="stylesheet" type="text/css"
	href="css/scroller.dataTables.min.css" />

<style type="text/css">
.container {
    display: flex;
    justify-content: space-between;
    align-items: stretch;
    padding: 20px;    
}

.column {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    align-items: flex-start;
    flex-grow: 2;
    justify-content: center; /* align item horizontally */
    align-items: center; /* align item vertically */
}

.row {
	justify-content: center; /* align item horizontally */
    align-items: center; /* align item vertically */
	display: flex;
	flex-direction: row;
	flex-grow: 2;
	position: relative;
	width:100%;
}

.content {
	justify-content: center; /* align item horizontally */
    align-items: center; /* align item vertically */
	display: flex;
	flex-grow: 1;	
	vertical-align: middle;	
	align-items: center; 
	align-content: center;
}
</style>


</head>
<body>
<div id="calibration_div">
	<div style="display: flex; flex-direction: column; height: 100%; align-content: center;">
		<div style="display: flex; flex-grow: 2;">
			<table id="calibration_table" class="datatables display my-table"
				style="width: 100%">
				<thead>
					<tr>
						<th>ID</th>
						<th>COL</th>
						<th>ROW</th>
						<th>CALIBRATED</th>
						<th>Options</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
		
		<div>
			<form id="cal_point_info">			
				<div style="display: flex; flex-direction: row;">
				Tube Id:<input type="text" id="cal_tube_info_id" name="id" size="4"> 
					Col:<input type="text" id="cal_tube_info_col" size="4"> 
					Row:<input type="text" id="cal_tube_info_row" size="4"> 
				</div>
				<div class="container">
			        <div class="column">
			        	<div class="row"><div class="content">&nbsp;</div><div class="content">Theo</div><div class="content"></div><div class="content">Determined</div></div>
			            <div class="row"><div class="content">X:</div><div class="content"><input type="text" id="ideal_coords_x" size="6"></div><div class="content"><input type="text" id="determined_coords_x" name="determined_coords_x" size="6"></div></div>
			            <div class="row"><div class="content">Y:</div><div class="content"><input type="text" id="ideal_coords_y" size="6"></div><div class="content"><input type="text" id="determined_coords_y" name="determined_coords_x" size="6"></div></div>
			            <div class="row"><div class="content">Z:</div><div class="content"><input type="text" id="ideal_coords_z" size="6"></div><div class="content"><input type="text" id="determined_coords_z" name="determined_coords_x" size="6"></div></div>
			        </div>
			        <div class="column" style="vertical-align: middle; align-items: center;">
			            <button id="determine_center">Determine</button>
			            <button id="determine_center">Update</button>
			        </div>
			    </div>
			</form>				
		</div>
	</div>
</div>

<script type="text/javascript">

//Shows information of the selected tube either on the datatables or the HX itself
function show_cal_point_info(data) {	
	$("#cal_tube_info_id").val(data.tube_id);
	$("#cal_tube_info_col").val(data.col);
	$("#cal_tube_info_row").val(data.row);
	$("#ideal_coords_x").val(data.ideal_coords.x);
	$("#ideal_coords_y").val(data.ideal_coords.y);
	$("#ideal_coords_z").val(data.ideal_coords.z);
	$("#determined_coords_x").val(data.determined_coords.x);
	$("#determined_coords_y").val(data.determined_coords.y);
	$("#determined_coords_z").val(data.determined_coords.z);

}

$(function() {
	var table = $('#calibration_table')
	.DataTable(
			{
				deferRender: true,
				select : true,
				scrollX : true,						
				ajax : {
					method : "GET",
					dataType : 'json',
					url : "/REST/calibration-points",
					data : function() {},
					dataSrc : '',
				},
				columns : [
						{
							data : 'tube_id'
						},
						{
							data : 'col'
						},
						{
							data : 'row'
						},
						{
							data : '',
							render : function(data, type, row) {
								return '<input type="checkbox" value='
										+ row.tube_id
										+ (data == true ? ' checked'
												: '') + '>';
							}
						},
						{
							data : null,
							render : function(data, type, row) {
								return '<a class="ui-icon ui-icon-trash" href="#" data-tube_id="'
										+ row.tube_id + '">' + row.tube_id
										+ '</a>';
							}
						}, 
				],
				
			});
	
	table.on('draw.dt', function(e, settings, json, xhr) {			
		$(".ui-icon-trash").on("click", function() {
			console.log($(this).data);
			var tube_id = $(this).data("tube_id").toString();
			
			var confirm_action = confirm("Are you sure you want to delete " + tube_id + " ?");
	        if (confirm_action) {
	        	$.ajax({
					url : "/REST/calibration-points/" + tube_id,
					type : "DELETE",
					success: function(data) {
						table.ajax.reload();
					},
					error: function(xhr, status, error) {
						alert("Error");
						console.log("Error", status, error);
					}						
	        	});
	        }
		});
	});
	
	
	table.on('click', 'tr',
		function() {				
			currentRow = table.row(this);					// Store the selected row on click
			if (!currentRow.selected()) {
				var data = currentRow.data();									
				show_cal_point_info(data);
			} else {
				$("#cal_point_info input[type=text]").val("");
			}
		}
	);

	$("#determine_center").click(function() {
	Promise.resolve(
		$.ajax({
			method : "GET",
			url : "/REST/determine-tube-center",
			data : JSON.stringify(),
			timeout: 25000,
		}))
		.then(function(data) {
			var svg = $("#tubesheet_svg").svg("get");		
			console.log("Scale:", scale);
			data.center.x *= scale;
			data.center.y *= scale;
			data.center.z *= scale;
			drawCircle(svg, data.center, data.radius, scale);
			
			$("#determined_coords_x").val(data.center.x * scale);
			$("#determined_coords_y").val(data.center.y * scale);
			$("#determined_coords_z").val(data.center.z * scale);
		
			$(data.transformed_points).each(function (p) {
				drawCircle(svg, this, 0.05, scale);
			});								
		})
		.catch(function(e) {
			if(e.statusText == 'timeout') {     
			    // TODO Send a cancel command? 
				alert('Please have the touch prove inserted into the tube to be detected');
		    
			  }
		});			
	}); 

	$("#set_as_cal_point").click(function(e) {
		e.preventDefault();
		$.ajax({
			method : "POST",
			url : "/REST/calibration-points",
			data: JSON.stringify(Object.fromEntries(new FormData(document.getElementById("tube_info")))),		// from hx.html
			success : function() {
				table = $('#calibration_table').DataTable();
				table.ajax.reload();
			},
			error: function(xhr, status, error) {
				alert("Error");
				console.log("Error", status, error);
			}						
		});
	});

});

</script>

</body>
</html>

