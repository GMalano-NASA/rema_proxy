<html lang="en">
<head>
<meta charset="UTF-8">
<title>REMA Control</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="stylesheet" href="css/styles.css">

<style type="text/css">
.row {
	display: flex;
}

.col {
	display: flex;
	flex: 1;
	justify-content: center;
	align-items: center;
}

.temperature {
	margin: 2px;
	padding: 3px;
	justify-content: center;
	align-items: center;
}

.normal {
	background-color: green;
}

.danger {
	background-color: yellow;
}

.high {
	background-color: red;
}
</style>

<script src="js/jquery.js"></script>
<script src="js/jquery.sse.min.js"></script>

<link rel="stylesheet" href="css/jquery-ui.css">
<script src="js/jquery-ui.min.js"></script>
</head>


<body>

	<div id="tabs" style="height: 94.5%">
		<ul>
			<li><a href="session.html">Session</a></li>
			<li><a href="tubesheet.html">Tubesheet</a></li>
			<li><a href="closed_loop.html">Closed Loop</a></li>
			<li><a href="hx.html">HX</a></li>
			<li><a href="config.html">Config</a></li>
			<li><a href="logs.html">Logs</a></li>
			<li><a href="tool.html">Tools</a></li>
			<li><a href="about.html">About</a></li>
			<!-- 			<li><a href="websocket.html">Websocket</a></li> -->
			<li style="float: right;">
				<div style="margin-top: 6; margin-right: 20">
					Selected Tool: <select id="tools"><option data-offset_x="0" data-offset_y="0" data-offset_z="0">Choose
							a Tool</option></select> Offset X: <input type="text" id="offset_x"
						readonly="readonly" size="4"> Y: <input type="text"
						id="offset_y" readonly="readonly" size="4">
						Z: <input type="text"
						id="offset_z" readonly="readonly" size="4">
						<span class="units">inch</span>
				</div>
			</li>
		</ul>
	</div>
	<div style="overflow: hidden; padding-top: 5px;" class="row">
		<div style="float: left; justify-content: left; max-width: 10%"
			class="col">
			<div>
				<img alt="" src="images/logo nasa.png">
			</div>
		</div>
		<div style="float: left; justify-content: left; max-width: 20%"
			class="col">
			Temperatures:
			<div class="temperature normal" id="temperature_x">__._ºC</div>
			<div class="temperature normal" id="temperature_y">__._ºC</div>
			<div class="temperature normal" id="temperature_z">__._ºC</div>
		</div>

		<div style="float: left;" class="col">
			Position X:<input type="text" id="position_x" name="position X"
				readonly="readonly" size="4">&nbsp; Y:<input type="text"
				id="position_y" name="position Y" readonly="readonly" size="4">&nbsp;
			Z:<input type="text" id="position_z" name="position Z"
				readonly="readonly" size="4">&nbsp; <span class="units">inch</span>
		</div>
		<div class="col">
			<span style="float: right; padding-right: 10px;" id="sse"></span> <span
				style="float: right; color: red; opacity: 0;" id="reconnect">Connection 
				Lost... <a href="#" id="reconnect_rema">Reconnect REMA</a>
			</span>
			<div style="float: left; display: none;" class="col"
				id="joystick_btn_div">
				<input type="button" value="Joystick" id="joystick_btn" />
			</div>
		</div>
	</div>

	<div id="joystick_div" style="overflow: hidden;"></div>


</body>

<script type="text/javascript">

scale = 1;

function get_session_info_index() {
	return $.get('/REST/current-session/info');
}

get_session_info_index()
		.done(
				function(data) {					
					active_tab = 0;
					if (data.is_loaded) {
						$(".units").text(data.unit);
						scale = data.unit == "mm" ? 25.4 : 1;
						active_tab = 3
					}

					$("#tabs").tabs({
						active : active_tab,
						//heightStyle : "fill"			
						activate : function(event, ui) {
							$(ui.oldPanel).find(".tabs_div").trigger("unload_tab");
						}
					});

					$.get('/REST/REMA/info', function(data) {
						var tools_dropdown = $('#tools');
						$.each(
								data.tools,
								function(key, entry) {
									tools_dropdown
											.append($('<option></option>')
													.attr(
															'value',
															entry.name)
													.attr(
															'data-offset_x',
															entry.offset_x)
													.attr(
															'data-offset_y',
															entry.offset_y)														
													.attr(
															'data-offset_z',
															entry.offset_z)														
													.text(
															entry.name));
								});

								tools_dropdown.change(function() {
									offset_x = $("option:selected", this).data("offset_x");
									offset_y = $("option:selected", this).data("offset_y");
									offset_z = $("option:selected", this).data("offset_z");
									$("#offset_x").val(offset_x * scale);
									$("#offset_y").val(offset_y * scale);
									$("#offset_z").val(offset_z * scale);
									var tool_name = $("option:selected", this).val();
									$.post('/REST/tools/' + tool_name + '/select');								
								});
						
								tools_dropdown.val(data.last_selected_tool).change();	
							}										
					);			
				}
		);
				
				

	function update_ui(telemetry, scale) {		
		var pos_x = telemetry.coords.x * scale + parseFloat($("#offset_x").val());
		var pos_y = telemetry.coords.y * scale + parseFloat($("#offset_y").val());
		var pos_z = telemetry.coords.z * scale + parseFloat($("#offset_z").val());
		$("#position_x").val(pos_x.toFixed(4));
		$("#position_y").val(pos_y.toFixed(4));
		$("#position_z").val(pos_z.toFixed(4));	

		if (telemetry.on_condition.x_y) {
			$("#messages").html("XY ON CONDITION");
		} else {
			$("#messages").html("");
		}
		
		if (typeof update_limits === "function") {
			update_limits(telemetry.limits);
		}
		
		if (typeof update_bullseye_position === "function") {
			update_bullseye_position(pos_x, pos_y);
		}		
	}
	
	function temp_ranges(temp) {
		if (temp > 30) {
			return "high";
		}  
		
		if (temp > 25) {
			return "danger";
		}
		
		return "normal";		
	}
	
	function update_temps(temps) {
		
		var temp_x = (temps.x / 10).toFixed(1);
		var temp_y = (temps.y / 10).toFixed(1);
		var temp_z = (temps.z / 10).toFixed(1);
		$("#temperature_x").text(temp_x + "ºC");
		$("#temperature_y").text(temp_y + "ºC");
		$("#temperature_z").text(temp_z + "ºC");
				
		$("#temperature_x").removeClass().addClass("temperature").addClass(temp_ranges(temp_x));
		$("#temperature_y").removeClass().addClass("temperature").addClass(temp_ranges(temp_y));
		$("#temperature_z").removeClass().addClass("temperature").addClass(temp_ranges(temp_z));
	}

	function set_cal_point() {
		var pos_x = (parseFloat($("#tube_info_x").val()) / scale) - parseFloat($("#offset_x").val() / scale);
		var pos_y = (parseFloat($("#tube_info_y").val()) / scale) - parseFloat($("#offset_y").val() / scale);

		$.ajax({
			url : "/REMA/",
			method : "POST",
			contentType : "application/json",
			data : JSON.stringify({
				commands : [ {
					command : "SET_CAL_POINT",
					pars : {
						position_x : pos_x,
						position_y : pos_y,
					}
				} ]
			}),
			dataType : "json",
			success : function(data) {				
			}
		});
	}

	function create_joystick() {
		
		$.when(
			    $.get('joystick.html', function(data) {
			        $('#joystick_div').html(data);
			    }),
			).done(function() {
				var joystick = $("#joystick_div").dialog({
					autoOpen : true,
					title : "Joystick",
					position: { my: "right bottom", at: "right-500 bottom-150", of: $("#tabs") },
					//modal : true,
					open: function(event, ui) {
						$("#joystick_btn_div").hide();
					},
					close: function(event, ui) {
						$("#joystick_btn_div").show();
					},

				});	
				$("#joystick_btn").click(function() {
					joystick.dialog("open");
				}) 
			});
	}
	
	$(function() {
	
		$("#reconnect_rema").click(function(){
			$.ajax({
				method : "POST",
				dataType : 'json',
				url : "/REST/REMA/connect",
			});			
		});
		
		// Handle Server Side Events
		var sse = $.SSE('/sse', {
			onMessage : function(e) {
				jdata = JSON.parse(e.data);
				
				if ("SESSION_MSG" in jdata) {
					$("#sse").text(jdata.SESSION_MSG).animate({
						opacity : 1
					}, 2000).animate({
						opacity : 0
					}, 2000);
				}
				
				if ("SHOW_CONNECT" in jdata) {
					$("#reconnect").animate({
						opacity : 1
					}, 0);						
				}
				
				if ("HIDE_CONNECT" in jdata) {
					$("#reconnect").animate({
						opacity : 0
					}, 2000);		
				}
				if ("TELEMETRY" in jdata) {
					update_ui(jdata.TELEMETRY, scale);
				}
				
				if ("TEMP_INFO" in jdata) {
					update_temps(jdata.TEMP_INFO);
				}

			},
		});
		sse.start();

	    create_joystick();
				
	});
		
	
</script>

</html>
